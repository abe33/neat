<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <title>neat - Compilation and Packaging</title>
    <link rel='stylesheet' media='screen' href='pages.css'>
    <link href='http://netdna.bootstrapcdn.com/font-awesome/3.0/css/font-awesome.css' type='text/css' rel='stylesheet'>
    <link href='http://fonts.googleapis.com/css?family=Lato:300' rel='stylesheet' type='text/css'>
    <script src='http://code.jquery.com/jquery-1.6.2.min.js' type='text/javascript' charset='utf-8'></script>
    <script>
      $(document).ready(function(){
        var pres = $('pre code')
        pres.each(function(i,el){
          el = $(el)
          var text = el.html()
          var lines = text.split('\n')
          el.parent().append('<ol>' + lines.map(function(l){
            return '<li></li>'
          }).join('\n') + '</ol>')
        })
      })
    </script>
  </head>
  <body>
    <div id='main'>
      <header>
  <h1>neat</h1>
  <p>1.1.1</p>
</header>
      <nav>
  <ul>
    <li>
      <a class='icon-home' href='index.html'>Home</a>
    </li>
    <li>
      <a class='icon-file-alt' href='pages_index.html'>Pages</a>
    </li>
    <li>
      <a class='icon-sitemap' href='docs/src_index.html'>Documentation</a>
    </li>
    <li>
      <a class='icon-github' href='http://github.com/abe33/neat'>GitHub</a>
    </li>
  </ul>
</nav>
      <section><h1 id='compilation-and-packaging'>Compilation and Packaging</h1>
<p><code>Neat</code> is clearly opiniated and favor <code>CoffeeScript</code> over pure <code>JavaScript</code>.
As result, Neat provides tools to deal with compilation and packaging of
<code>coffee</code> files for both node and browsers.

</p>
<p>These tools will allow you to perform operation on files at any point
of the process. And you can even easily build your own operators.

</p>
<p>Most of the hard work is handled by the <code>cake package</code> task,
also aliased as <code>cake compile</code>. Basically, it takes a bunch
of compilation configuration files, loaded from the
<code>config/packages</code> directory, and process them.

</p>
<p><h3>Table Of Content</h3>
<ul class='toc'>
  <li class='level0'>
    <a href='#compilation-and-packaging'>Compilation and Packaging</a>
  </li>
  <li class='level1'>
    <a href='#package-configuration'>Package Configuration</a>
  </li>
  <li class='level1'>
    <a href='#custom-configuration'>Custom Configuration</a>
  </li>
  <li class='level1'>
    <a href='#operators'>Operators</a>
  </li>
  <li class='level2'>
    <a href='#codeannotateclasscode'><code>annotate:class</code></a>
  </li>
  <li class='level2'>
    <a href='#codeannotatefilecode'><code>annotate:file</code></a>
  </li>
  <li class='level2'>
    <a href='#codecompilecode'><code>compile</code></a>
  </li>
  <li class='level2'>
    <a href='#codecreatefilecode'><code>create:file</code></a>
  </li>
  <li class='level2'>
    <a href='#codecreatedirectorycode'><code>create:directory</code></a>
  </li>
  <li class='level2'>
    <a href='#codeexportspackagecode'><code>exports:package</code></a>
  </li>
  <li class='level2'>
    <a href='#codeheaderlicensecode'><code>header:license</code></a>
  </li>
  <li class='level2'>
    <a href='#codejoincode'><code>join</code></a>
  </li>
  <li class='level2'>
    <a href='#codepathchangecode'><code>path:change</code></a>
  </li>
  <li class='level2'>
    <a href='#codepathresetcode'><code>path:reset</code></a>
  </li>
  <li class='level2'>
    <a href='#codestriprequirescode'><code>strip:requires</code></a>
  </li>
  <li class='level2'>
    <a href='#codeuglifycode'><code>uglify</code></a>
  </li>
  <li class='level1'>
    <a href='#custom-operators'>Custom Operators</a>
  </li>
</ul>

</p>
<h2 id='package-configuration'>Package Configuration</h2>
<p>Compilation configuration file are <a href="cup.html">cup files</a> defining
the files to include in the package, in which order, and what to do with
them.

</p>
<p>The default compilation configuration file (the one created for a new project)
look like that:

</p>
<pre><code><span class="property">name<span class='punctuation'>:</span></span> <span class="string"><span class="string_begin">"</span>myProject<span class="string_end">"</span></span>
<span class="property">path<span class='punctuation'>:</span></span> <span class="string"><span class="string_begin">'</span>lib<span class="string_end">'</span></span>
<span class="property">includes<span class='punctuation'>:</span></span> <span class="punctuation">[</span>
  <span class="string"><span class="string_begin">'</span>src/**/*.coffee<span class="string_end">'</span></span>
<span class="punctuation">]</span>
<span class="property">operators<span class='punctuation'>:</span></span> <span class="punctuation">[</span>
  <span class="string"><span class="string_begin">'</span>path:change<span class="string_end">'</span></span>
  <span class="string"><span class="string_begin">'</span>path:reset<span class="string_end">'</span></span>
  <span class="string"><span class="string_begin">'</span>compile<span class="string_end">'</span></span>
  <span class="string"><span class="string_begin">'</span>create:file<span class="string_end">'</span></span>
<span class="punctuation">]</span></code></pre>
<p>The first property <code>name</code> is only used to define the final filename when using
the <code>join</code> operator, but is also useful as reminder.

</p>
<p>The <code>path</code> property is an option for the <code>path:change</code> and <code>path:reset</code>
operators, it defines the relative path, inside the project, where place
the packaged files. By default the package tasks place output files in
the <code>packages</code> directory, this operator allow you to change that from
a configuration file.

</p>
<p>The <code>includes</code> property is an array that contains
<a href="https://github.com/isaacs/node-glob"><code>glob</code></a> patterns of files to include
in the package. These files are read and then stored in a hash with the file
path as key and its content as value as returned by <code>fs.readFile</code>.
This <code>buffer</code> will be passed sequencially to the specified <code>operators</code>.

</p>
<p>The <code>operators</code> property is an arrays containing the identifier of the
operators to apply to the packaged files. See below for the details about
operators.

</p>
<h2 id='custom-configuration'>Custom Configuration</h2>
<p>Neat provides a generator to create compilation configuration file, run :
</p>
<pre><code class="lang-bash">neat generate config:packager my_package_name</code></pre>
<p>And then a <code>my_package_name.cup</code> will have been generated
in the <code>config/packages</code> directory.

</p>
<p>You can obviously create your configuration file by hand, just keep
in mind that the minimal requirement a compilation configuration need
to fullfil is to have the following properties:
</p>
<pre><code><span class="property">includes<span class='punctuation'>:</span></span> <span class="punctuation">[</span><span class="punctuation">]</span>
<span class="property">operators<span class='punctuation'>:</span></span> <span class="punctuation">[</span><span class="punctuation">]</span></code></pre>
<h2 id='operators'>Operators</h2>
<p>Operators are simple asynchronous function with the following signature:
</p>
<pre><code>my_operator <span class="operators">=</span> <span class="group"><span class="group_begin">(</span>buffer<span class="punctuation">,</span> config<span class="punctuation">,</span> errCallback<span class="punctuation">,</span> callback<span class="group_end">)</span></span> <span class="function">-></span>
  <span class="comment"># must return a buffer, config and errCallback in the callback for chaining.</span>
  callback buffer<span class="punctuation">,</span> config<span class="punctuation">,</span> errCallback</code></pre>
<p>Given the files that were found using the patterns in <code>includes</code>, an object
is created with the path of the file as key and its content as value.
This object is then passed to the first operator in the list and processed
all along the stack of operators.

</p>
<p>Note that some operators return a buffer where all the paths was changed,
it means that the order of the operators will have an impact on their
utility. For instance the <code>annotate</code> operators may allways be placed
before a <code>join</code> or any other operator that changes the path or the content
of the file, if not, the files and line numbers present in the annotations
won&#39;t make sense.

</p>
<p>The following operators are available from start at this time:

</p>
<h5 id='codeannotateclasscode'><code>annotate:class</code></h5>
<p>Annotates a class with comments for all its members.
The annotation appears as javascript comments wrapped in backticks.
</p>
<pre><code><span class="embedded"><span class="embedded_begin">`</span>/* /path/to/file&lt;Class&gt: line: X */<span class="embedded_end">`</span></span>
<span class="embedded"><span class="embedded_begin">`</span>/* /path/to/file&lt;Class.member&gt: line: X */<span class="embedded_end">`</span></span>
<span class="embedded"><span class="embedded_begin">`</span>/* /path/to/file&lt;Class::member&gt: line: X */<span class="embedded_end">`</span></span></code></pre>
<h5 id='codeannotatefilecode'><code>annotate:file</code></h5>
<p>Annotates the files start with a header comment.
The annotation appears as javascript comments wrapped in backticks.
</p>
<pre><code><span class="embedded"><span class="embedded_begin">`</span>/* /path/to/file */<span class="embedded_end">`</span></span></code></pre>
<h5 id='codecompilecode'><code>compile</code></h5>
<p>Compiles the files in the buffer through CoffeeScript.
The extension in the file path is replaced with <code>.js</code>.
The <code>compile</code> operator accept a <code>bare</code> property which, when true,
compile the source without the wrapper function.

</p>
<h5 id='codecreatefilecode'><code>create:file</code></h5>
<p>Creates the output files in their respectives path.
This operator can be called anytime, meaning you can, in one config,
produce and output a joined CoffeeScript file, then the compiled
javascript file, and then the minified Javascript file, below an example:
</p>
<pre><code><span class="property">operators<span class='punctuation'>:</span></span> <span class="punctuation">[</span>
  <span class="comment"># ...</span>
  <span class="string"><span class="string_begin">'</span>create:file<span class="string_end">'</span></span> <span class="comment"># create the coffee files</span>
  <span class="string"><span class="string_begin">'</span>compile<span class="string_end">'</span></span>
  <span class="string"><span class="string_begin">'</span>create:file<span class="string_end">'</span></span> <span class="comment"># create the js files</span>
  <span class="string"><span class="string_begin">'</span>uglify<span class="string_end">'</span></span>
  <span class="string"><span class="string_begin">'</span>create:file<span class="string_end">'</span></span> <span class="comment"># create the minified js files</span>
<span class="punctuation">]</span></code></pre>
<h5 id='codecreatedirectorycode'><code>create:directory</code></h5>
<p>Creates a sub-directory of the packages folder defined with the <code>directory</code>
property. All the paths in the buffer will be changed to be included
in the path.
</p>
<pre><code><span class="property">path<span class='punctuation'>:</span></span> <span class="string"><span class="string_begin">'</span>lib<span class="string_end">'</span></span>
<span class="property">directory<span class='punctuation'>:</span></span> <span class="string"><span class="string_begin">'</span>demos<span class="string_end">'</span></span>
<span class="property">operators<span class='punctuation'>:</span></span> <span class="punctuation">[</span>
  <span class="comment"># ...</span>
  <span class="string"><span class="string_begin">'</span>create:directory<span class="string_end">'</span></span> <span class="comment"># creates the directory and change files path</span>
  <span class="string"><span class="string_begin">'</span>create:file<span class="string_end">'</span></span>      <span class="comment"># creates the files at their new path</span>
<span class="punctuation">]</span></code></pre>
<h5 id='codeexportspackagecode'><code>exports:package</code></h5>
<p>Replaces all node exports as package affectation.
The operator require the definition of a package property in the
configuration such as :
</p>
<pre><code><span class="property">package<span class='punctuation'>:</span></span> <span class="string"><span class="string_begin">'</span>path.to.package<span class="string_end">'</span></span></code></pre>
<p>It will inject a package declaration at the top of each files in the buffer
such as:
</p>
<pre><code><span class="property">@path</span> <span class="operators">|</span><span class="operators">|</span><span class="operators">=</span> <span class="hash"><span class="hash_begin">{</span><span class="hash_end">}</span></span>
<span class="property">@path</span><span class="punctuation">.</span>to <span class="operators">|</span><span class="operators">|</span><span class="operators">=</span> <span class="hash"><span class="hash_begin">{</span><span class="hash_end">}</span></span>
<span class="property">@path</span><span class="punctuation">.</span>to<span class="punctuation">.</span>package <span class="operators">|</span><span class="operators">|</span><span class="operators">=</span> <span class="hash"><span class="hash_begin">{</span><span class="hash_end">}</span></span></code></pre>
<p>Below is various use cases and their results:
</p>
<pre><code><span class="comment"># before</span>
<span class="global">exports</span><span class="punctuation">.</span>a <span class="operators">=</span> <span class="function">-></span> <span class="comment">#...</span>
<span class="comment"># after</span>
<span class="property">@path</span><span class="punctuation">.</span>to<span class="punctuation">.</span>package<span class="punctuation">.</span>a <span class="operators">=</span> <span class="function">-></span> <span class="comment">#...</span></code></pre>
<pre><code><span class="comment"># before</span>
<span class="global">exports</span><span class="punctuation">[</span><span class="string"><span class="string_begin">'</span>a<span class="string_end">'</span></span><span class="punctuation">]</span> <span class="operators">=</span> <span class="function">-></span> <span class="comment">#...</span>
<span class="comment"># after</span>
<span class="property">@path</span><span class="punctuation">.</span>to<span class="punctuation">.</span>package<span class="punctuation">[</span><span class="string"><span class="string_begin">'</span>a<span class="string_end">'</span></span><span class="punctuation">]</span> <span class="operators">=</span> <span class="function">-></span> <span class="comment">#...</span></code></pre>
<pre><code><span class="comment"># before</span>
<span class="global">module</span><span class="punctuation">.</span><span class="global">exports</span> <span class="operators">=</span> <span class="hash"><span class="hash_begin">{</span>a<span class="punctuation">,</span>b<span class="punctuation">,</span><span class="property">c<span class='punctuation'>:</span></span> <span class="number">10</span><span class="hash_end">}</span></span>
<span class="comment"># after</span>
<span class="property">@path</span><span class="punctuation">.</span>to<span class="punctuation">.</span>package<span class="punctuation">.</span>a <span class="operators">=</span> a
<span class="property">@path</span><span class="punctuation">.</span>to<span class="punctuation">.</span>package<span class="punctuation">.</span>b <span class="operators">=</span> b
<span class="property">@path</span><span class="punctuation">.</span>to<span class="punctuation">.</span>package<span class="punctuation">.</span>c <span class="operators">=</span> <span class="number">10</span></code></pre>
<pre><code><span class="comment"># before</span>
<span class="global">module</span><span class="punctuation">.</span><span class="global">exports</span> <span class="operators">=</span> <span class="constant">MyClass</span>
<span class="comment"># after</span>
<span class="property">@path</span><span class="punctuation">.</span>to<span class="punctuation">.</span>package<span class="punctuation">.</span><span class="constant">MyClass</span> <span class="operators">=</span> <span class="constant">MyClass</span>
<span class="comment"># When a variable name is affected as exports, the variable</span>
<span class="comment"># name is used as property name on the package. It's useful</span>
<span class="comment"># to have a class available as module in node and accessible</span>
<span class="comment"># through its name when stored in a package.</span></code></pre>
<h5 id='codeheaderlicensecode'><code>header:license</code></h5>
<p>Insert the content of a license file as header comment in all generated
files. The license file is specfied in a <code>license</code> property
in the configuration file.

</p>
<h5 id='codejoincode'><code>join</code></h5>
<p>Joins all the files in the buffer in the order defined in
the include parameter and changes the filename with the specified
name parameter.

</p>
<h5 id='codepathchangecode'><code>path:change</code></h5>
<p>Changes the path of the files in the buffer with the path
defined in the path property.
For a file such <code>{root}/src/dir/file.coffee</code> and a path such as <code>lib</code>,
the resulting path will be <code>{root}/lib/dir/file.coffee</code>.
The <code>path</code> property is mandatory.

</p>
<h5 id='codepathresetcode'><code>path:reset</code></h5>
<p>Removes and then recreates the defined path.

</p>
<h5 id='codestriprequirescode'><code>strip:requires</code></h5>
<p>Removes all the lines in a CoffeeScript file that
contain a call to <code>require</code>. Calls to <code>require</code> in comments are preserved.

</p>
<h5 id='codeuglifycode'><code>uglify</code></h5>
<p>Runs uglification on the buffer. The path of the files contained
in the buffer are then suffixed with <code>.min.js</code> rather than <code>.js</code>.

</p>
<h2 id='custom-operators'>Custom Operators</h2>
<p>Operators are defined in the <code>operatorsMap</code> of the <code>tasks.package</code> config
namespace. To start creating your firsts operators generate a new initializer:

</p>
<pre><code class="lang-bash">neat g initializer tasks/package/my_operators</code></pre>
<p>Then you can start adding your own operators in the newly created initializer:
</p>
<pre><code><span class="global">module</span><span class="punctuation">.</span><span class="global">exports</span> <span class="operators">=</span> <span class="group"><span class="group_begin">(</span>config<span class="group_end">)</span></span> <span class="function">-></span>
  config<span class="punctuation">.</span>tasks<span class="punctuation">.</span>package<span class="punctuation">.</span>operatorsMap<span class="punctuation">.</span>merge
    <span class="property">my_operator<span class='punctuation'>:</span></span> <span class="group"><span class="group_begin">(</span>buffers<span class="punctuation">,</span> config<span class="punctuation">,</span> errCallback<span class="punctuation">,</span> callback<span class="group_end">)</span></span> <span class="function">-></span>
      <span class="keyword">for</span> path<span class="punctuation">,</span> content <span class="keyword">of</span> buffer
        buffer<span class="punctuation">[</span>path<span class="punctuation">]</span> <span class="operators">=</span> someOperationOn<span class="group"><span class="group_begin">(</span>content<span class="group_end">)</span></span>
      callback buffers<span class="punctuation">,</span> config<span class="punctuation">,</span> errCallback</code></pre>
</section>
      <footer>
  <nav>
    <h4>Links</h4>
    <ul>
      <li>
        <a href='http://github.com/abe33/neat/issues/'>Issues</a>
      </li>
      <li>
        <a href='docs/src_index.html'>Documentation</a>
      </li>
      <li>
        <a href='http://github.com/abe33/neat'>GitHub</a>
      </li>
    </ul>
  </nav>
  <div class='vcard' id='contact'>
    <h4>Contact</h4>
    <ul>
      <li class='icon-envelope-alt'>
        <a class='email fn' href='mailto:cedric.nehemie@gmail.com'>Cédric Néhémie</a>
      </li>
      <li class='icon-home'>
        <a class='fn url website' href='http://cedric.nehemie.com'>http://cedric.nehemie.com</a>
      </li>
      <li class='icon-twitter'>
        <a class='twitter' href='http://twitter.com/cedricnehemie'>@cedricnehemie</a>
      </li>
    </ul>
  </div>
  <p class='copyright'>&copy; Copyright 2012 Cédric Néhémie</p>
</footer>
    </div>
  </body>
</html>